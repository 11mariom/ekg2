#include "char.h"
#include "xmalloc.h"

/* ripperd from http://interif.org/links/download/old-patches/links-1.00pre12.diff.gz patch (c Jakub Bogusz <qboosh@pld-linux.org> ) */
struct table_entry table_cp1250 [] = {
	{ 0x80, 0x20AC }, { 0x81, 0x0000 }, { 0x82, 0x201A }, { 0x83, 0x0000 }, { 0x84, 0x201E }, { 0x85, 0x2026 }, { 0x86, 0x2020 },
	{ 0x87, 0x2021 }, { 0x88, 0x0009 }, { 0x89, 0x2030 }, { 0x8A, 0x0160 }, { 0x8B, 0x2039 }, { 0x8C, 0x015A }, { 0x8D, 0x0164 }, 
	{ 0x8E, 0x017D }, { 0x8F, 0x0179 }, { 0x90, 0x0000 }, { 0x91, 0x2018 }, { 0x92, 0x2019 }, { 0x93, 0x201C }, { 0x94, 0x201D },
	{ 0x95, 0x2022 }, { 0x96, 0x2013 }, { 0x97, 0x2014 }, { 0x98, 0x0000 }, { 0x99, 0x2122 }, { 0x9A, 0x0161 }, { 0x9B, 0x203A },
	{ 0x9C, 0x015B }, { 0x9D, 0x0165 }, { 0x9E, 0x017E }, { 0x9F, 0x017A }, { 0xA0, 0x00A0 }, { 0xA1, 0x02C7 }, { 0xA2, 0x02D8 },
	{ 0xA3, 0x0141 }, { 0xA4, 0x00A4 }, { 0xA5, 0x0104 }, { 0xA6, 0x00A6 }, { 0xA7, 0x00A7 }, { 0xA8, 0x00A8 }, { 0xA9, 0x00A9 },
	{ 0xAA, 0x015E }, { 0xAB, 0x00AB }, { 0xAC, 0x00AC }, { 0xAD, 0x00AD }, { 0xAE, 0x00AE }, { 0xAF, 0x017B }, { 0xB0, 0x00B0 },
	{ 0xB1, 0x00B1 }, { 0xB2, 0x02DB }, { 0xB3, 0x0142 }, { 0xB4, 0x00B4 }, { 0xB5, 0x00B5 }, { 0xB6, 0x00B6 }, { 0xB7, 0x00B7 },
	{ 0xB8, 0x00B8 }, { 0xB9, 0x0105 }, { 0xBA, 0x015F }, { 0xBB, 0x00BB }, { 0xBC, 0x013D }, { 0xBD, 0x02DD }, { 0xBE, 0x013E }, 
	{ 0xBF, 0x017C }, { 0xC0, 0x0154 }, { 0xC1, 0x00C1 }, { 0xC2, 0x00C2 }, { 0xC3, 0x0102 }, { 0xC4, 0x00C4 }, { 0xC5, 0x0139 },
	{ 0xC6, 0x0106 }, { 0xC7, 0x00C7 }, { 0xC8, 0x010C }, { 0xC9, 0x00C9 }, { 0xCA, 0x0118 }, { 0xCB, 0x00CB }, { 0xCC, 0x011A }, 
	{ 0xCD, 0x00CD }, { 0xCE, 0x00CE }, { 0xCF, 0x010E }, { 0xD0, 0x0110 }, { 0xD1, 0x0143 }, { 0xD2, 0x0147 }, { 0xD3, 0x00D3 },
	{ 0xD4, 0x00D4 }, { 0xD5, 0x0150 }, { 0xD6, 0x00D6 }, { 0xD7, 0x00D7 }, { 0xD8, 0x0158 }, { 0xD9, 0x016E }, { 0xDA, 0x00DA },
	{ 0xDB, 0x0170 }, { 0xDC, 0x00DC }, { 0xDD, 0x00DD }, { 0xDE, 0x0162 }, { 0xDF, 0x00DF }, { 0xE0, 0x0155 }, { 0xE1, 0x00E1 },
	{ 0xE2, 0x00E2 }, { 0xE3, 0x0103 }, { 0xE4, 0x00E4 }, { 0xE5, 0x013A }, { 0xE6, 0x0107 }, { 0xE7, 0x00E7 }, { 0xE8, 0x010D },
	{ 0xE9, 0x00E9 }, { 0xEA, 0x0119 }, { 0xEB, 0x00EB }, { 0xEC, 0x011B }, { 0xED, 0x00ED }, { 0xEE, 0x00EE }, { 0xEF, 0x010F },
	{ 0xF0, 0x0111 }, { 0xF1, 0x0144 }, { 0xF2, 0x0148 }, { 0xF3, 0x00F3 }, { 0xF4, 0x00F4 }, { 0xF5, 0x0151 }, { 0xF6, 0x00F6 },
	{ 0xF7, 0x00F7 }, { 0xF8, 0x0159 }, { 0xF9, 0x016F }, { 0xFA, 0x00FA }, { 0xFB, 0x0171 }, { 0xFC, 0x00FC }, { 0xFD, 0x00FD }, 
	{ 0xFE, 0x0163 }, { 0xFF, 0x02D9 }, { 0x00, 0x0000 }, };

struct table_entry table_iso8859_2 [] = {
	{ 0x80, 0x0080 }, { 0x81, 0x0081 }, { 0x82, 0x0082 }, { 0x83, 0x0083 }, { 0x84, 0x0084 }, { 0x85, 0x0085 }, { 0x86, 0x0086 },
	{ 0x87, 0x0087 }, { 0x88, 0x0088 }, { 0x89, 0x0089 }, { 0x8A, 0x008A }, { 0x8B, 0x008B }, { 0x8C, 0x008C }, { 0x8D, 0x008D }, 
	{ 0x8E, 0x008E }, { 0x8F, 0x008F }, { 0x90, 0x0090 }, { 0x91, 0x0091 }, { 0x92, 0x0092 }, { 0x93, 0x0093 }, { 0x94, 0x0094 },
	{ 0x95, 0x0095 }, { 0x96, 0x0096 }, { 0x97, 0x0097 }, { 0x98, 0x0098 }, { 0x99, 0x0099 }, { 0x9A, 0x009A }, { 0x9B, 0x009B },
	{ 0x9C, 0x009C }, { 0x9D, 0x009D }, { 0x9E, 0x009E }, { 0x9F, 0x009F }, { 0xA0, 0x00A0 }, { 0xA1, 0x0104 }, { 0xA2, 0x02D8 },
	{ 0xA3, 0x0141 }, { 0xA4, 0x00A4 }, { 0xA5, 0x013D }, { 0xA6, 0x015A }, { 0xA7, 0x00A7 }, { 0xA8, 0x00A8 }, { 0xA9, 0x0160 },
	{ 0xAA, 0x015E }, { 0xAB, 0x0164 }, { 0xAC, 0x0179 }, { 0xAD, 0x00AD }, { 0xAE, 0x017D }, { 0xAF, 0x017B }, { 0xB0, 0x00B0 },	
	{ 0xB1, 0x0105 }, { 0xB2, 0x02DB }, { 0xB3, 0x0142 }, { 0xB4, 0x00B4 }, { 0xB5, 0x0136 }, { 0xB6, 0x015B }, { 0xB7, 0x02C7 },
	{ 0xB8, 0x00B8 }, { 0xB9, 0x0161 }, { 0xBA, 0x015F }, { 0xBB, 0x0165 }, { 0xBC, 0x017A }, { 0xBD, 0x02DD }, { 0xBE, 0x017E }, 
	{ 0xBF, 0x017C }, { 0xC0, 0x0154 }, { 0xC1, 0x00C1 }, { 0xC2, 0x00C2 }, { 0xC3, 0x0102 }, { 0xC4, 0x00C4 }, { 0xC5, 0x0139 },
	{ 0xC6, 0x0106 }, { 0xC7, 0x00C7 }, { 0xC8, 0x010C }, { 0xC9, 0x00C9 }, { 0xCA, 0x0118 }, { 0xCB, 0x00CB }, { 0xCC, 0x011A }, 
	{ 0xCD, 0x00CD }, { 0xCE, 0x00CE }, { 0xCF, 0x010E }, { 0xD0, 0x0110 }, { 0xD1, 0x0143 }, { 0xD2, 0x0147 }, { 0xD3, 0x00D3 },
	{ 0xD4, 0x00D4 }, { 0xD5, 0x0150 }, { 0xD6, 0x00D6 }, { 0xD7, 0x00D7 }, { 0xD8, 0x0158 }, { 0xD9, 0x016E }, { 0xDA, 0x00DA },
	{ 0xDB, 0x0170 }, { 0xDC, 0x00DC }, { 0xDD, 0x00DD }, { 0xDE, 0x0162 }, { 0xDF, 0x00DF }, { 0xE0, 0x0155 }, { 0xE1, 0x00E1 },
	{ 0xE2, 0x00E2 }, { 0xE3, 0x0103 }, { 0xE4, 0x00E4 }, { 0xE5, 0x013A }, { 0xE6, 0x0107 }, { 0xE7, 0x00E7 }, { 0xE8, 0x010D },
	{ 0xE9, 0x00E9 }, { 0xEA, 0x0119 }, { 0xEB, 0x00EB }, { 0xEC, 0x011B }, { 0xED, 0x00ED }, { 0xEE, 0x00EE }, { 0xEF, 0x010F },
	{ 0xF0, 0x0111 }, { 0xF1, 0x0144 }, { 0xF2, 0x0148 }, { 0xF3, 0x00F3 }, { 0xF4, 0x00F4 }, { 0xF5, 0x0151 }, { 0xF6, 0x00F6 },
	{ 0xF7, 0x00F7 }, { 0xF8, 0x0159 }, { 0xF9, 0x016F }, { 0xFA, 0x00FA }, { 0xFB, 0x0171 }, { 0xFC, 0x00FC }, { 0xFD, 0x00FD },
	{ 0xFE, 0x0163 }, { 0xFF, 0x02D9 }, { 0x00, 0x0000 }, };


CHAR_T *normal_to_wcs_n(const char *str, int len) 
{
	if (!str)
		return NULL;
#if USE_UNICODE
	CHAR_T *tmp;
	if (len == -1)
		len = mbstowcs(NULL, str, 0)+1;
	tmp = xcalloc(len+1, sizeof(wchar_t));
	mbstowcs(tmp, str, len);
	return tmp;
#else
	return (char *) str;
#endif
}

CHAR_T *normal_to_wcs(const char *str)
{
	return normal_to_wcs_n(str, -1);
}

char *wcs_to_normal_n(const CHAR_T *str, int len) 
{
	if (!str)
		return NULL;
#if USE_UNICODE
	char *tmp;
	int ret;
	if (len == -1) {
		len = wcstombs(NULL,str,0);
		tmp = xmalloc(len+1);
	} else { 
		int tuptus = 0;
		int i;
		for (i=0; i < len; i++) {
			tuptus++;
			if (str[i] > 0x000000FF) tuptus++;
			if (str[i] > 0x0000FFFF) tuptus++;
			if (str[i] > 0x00FFFFFF) tuptus++;
		}
		tmp = xmalloc(tuptus+1);
//		if (tuptus != len) printf("[wcs_to_normal_n, info] tuptus = %d len = %d\n", tuptus, len);
		len = tuptus;
	}
	ret = wcstombs(tmp, str, len);
//	if (ret != len) printf("[wcs_to_normal_n, err] len = %d wcstombs = %d\n", ret, len);
	return tmp;
#else
	return (char *) str;
#endif
}

char *wcs_to_normal(const CHAR_T *str)
{
	return wcs_to_normal_n(str, -1);
}

